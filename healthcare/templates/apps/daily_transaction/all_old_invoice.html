{% extends "main.html" %}
{% load static %}
{% block pageHeader %}
<div class="page-header">
    <div class="row">
        <div class="col-sm-12">
            <h3 class="page-title">All Invoice Record</h3>
            <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">All Invoice</a></li>
                <li class="breadcrumb-item active">All Invoice</li>
            </ul>
        </div>


    </div>
</div>
{% endblock %}

{% block content %}

<!-- Search Filter -->
<div class="row bg-white ">

    <div class="col-md-10">
        <div id="" class=" filter-card">
            <div class="card-body pb-0">
                <form method="POST" action="{% url 'invoice-all' %}">
                    {% csrf_token %}
        
                    <div class="row">
                        <div class="col-sm-6 col-md-3">
                            <div class="form-group">
                                <label>Bill No</label>
                                <input type="text" name="search_bill" value="" class="form-control">
                            </div>
                        </div>
        
                        <div class="col-sm-6 col-md-3">
                            <div class="form-group pt-md-4">
                                <button type="submit" class="btn btn-primary">Search</button>
                            </div>
                        </div>
                    </div>
                </form>
                
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="mb-5 mx-4  mt-md-5">
            <a href="." class="btn btn-sm btn-danger">
                <i class="fa fa-undo shadow" data-bs-toggle="tooltip" title="fa fa-undo"></i>
              </a>
           
        </div>
       
     </div>

</div>

<!-- /Search Filter -->

<div class="card card-table">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-center table-hover invoice_table ">
                <thead class="thead-light">
                    <tr>
                        <th>Bill No</th>
                        <th>D.Name</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Volume</th>
                        <th>Unit</th>
                        <th>T. Amount</th>

                        {% comment %} <th>Print Status</th> {% endcomment %}
                        <th>Pay Status</th>
                        <th>Action</th>

                    </tr>
                </thead>
                <tbody>

                    {% for invoice in page_obj %}
                    <tr>
                        <td>{{invoice.id}}</td>
                        <td>
                            {{invoice.dispenser_name}}
                        </td>
                        <td>{{invoice.date}}</td>
                        <td>{{invoice.time}}</td>
                        <td>{{invoice.volume_of_gas}}</td>
                        <td>{{invoice.rate}}</td>
                        <td>{{invoice.total_amount}}</td>
                        <!-- <td>{{invoice.print_status}} </td> -->
                        {% comment %} <td>{% if invoice.print_status == "success" %} <span
                                class="badge badge-pill bg-success-light">{{invoice.print_status|title}} </span>
                            {% else %} <span
                                class="badge badge-pill bg-danger-light">{{invoice.print_status|title}}</span>
                            {% endif %}</td> {% endcomment %}

                        <td id="invoice_status">{% if invoice.payment_status == "PENDING" %} <span
                                class="badge badge-pill bg-danger-light">{{invoice.payment_status|title}} </span>
                            {% elif invoice.payment_status == "due"  %} <span
                                class="badge badge-pill bg-warning-light">{{invoice.payment_status|title}}</span>
                            {% else %} <span
                                class="badge badge-pill bg-success-light">{{invoice.payment_status|title}}</span>
                            {% endif %}</td>

                        <td>
                            <button type="button" class="btn btn-sm btn-danger text-white me-2  confirm-payment"
                                data-id="{{invoice.id}}" data-pay-status="{{invoice.payment_status}}"><i class="fa fa-money-bill me-1"></i>Pay</button>

                            <button type="button" id="customer_pay_button" class="btn btn-sm btn-info text-white me-2 " onclick="customer_payment('{{invoice.id}}','{{invoice.payment_status}}')" ><i
                                    class="fa fa-money-bill me-1"></i>C. Pay</button>

                            <button onclick="print_invoice('{{ invoice.id }}')" class="btn btn-sm btn-primary me-2"><i
                                    class="fa fa-print me-1"></i> Print</button>

                            <!-- <a href="#" class="btn btn-sm btn-white text-success me-2"><i class="far fa-edit me-1"></i> Edit</a> -->
                        </td>

                    </tr>
                    {% endfor %}

                </tbody>
            </table>

            {% if page_obj %}
            <div>
                <ul class="pagination mb-4 mt-1 mx-2">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}" tabindex="-1"> « Previous</a>
                    </li>
                        {% if page_obj.number > 3 %}
                            <li class="page-item"><a class="page-link" href="?page=1">1</a></li>
                            {% if page_obj.number > 4 %}
                            <li class="page-item">
                                <a class="page-link" href="">...</a>
                             </li>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                    
            
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                            
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                        {% endif %}
            
                    {% endfor %}
            
            
                    {% if page_obj.has_next %}
                    {% if page_obj.number < page_obj.paginator.num_pages|add:'-3' %}
                      <li class="page-item">
                        <a class="page-link" href="">...</a>
                     </li>
                      <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">{{ page_obj.paginator.num_pages }}</a></li>
                    {% elif page_obj.number < page_obj.paginator.num_pages|add:'-2' %}
                      <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">{{ page_obj.paginator.num_pages }}</a></li>
                    {% endif %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next Page »</a>
                    </li>
                     
                  {% endif %} 
                </ul>
            </div>
            {% endif %}
        </div>

            
        </div>
    </div>
</div>




{% endblock %}

{% block custom_script %}
<script src='{% static "plugins/datatables/jquery.dataTables.min.js" %}'> </script>
<script src='{% static "plugins/datatables/datatables.min.js" %}'></script>
<script>
    function print_invoice(id) {
        $.ajax({
            type: 'POST',
            url: "/invoice/print/" + id + "/",
            data: {
                'id': id
            },
            success: function (response) {
                console.log(response);
                if (response['error'] == 'true') {
                    // window.alert(response['msg']);
                    Swal.fire({
                        title: `${response['msg']}`,
                        confirmButtonClass: "btn btn-primary",
                        buttonsStyling: !1
                    })
                }
            }

        });
    }
    function customer_payment(id,payment_status) {

        console.log(id)
        console.log(payment_status)
        url = `${window.location.origin}/dashboard/customer-payment/${id}`
        // print(url)
        if(payment_status != 'paid')
            window.location = url;
        else if(payment_status == 'paid'){
            Swal.fire({
                        position: "top-end",
                        type: "success",
                        title: "Payment already paid",
                        showConfirmButton: !1,
                        timer: 1500,
                        confirmButtonClass: "btn btn-success",
                        buttonsStyling: !1
                        })
        }

        console.log(url)
                                   
    }
</script>

<!-- Sweetalert 2 -->
<script src='{% static "plugins/sweetalert/sweetalert2.all.min.js" %}'></script>
<script src='{% static "plugins/sweetalert/sweetalerts.min.js" %}'></script>

<script>
    $(document).ready(function () {

        function getInvoice(val) {
            console.log(val)
        }

        console.log(location.href)
        console.log($("#invoice_table tr td:first-child"))
    
        $(document).on('click', '.confirm-payment', function () {

            var dataId = $(this).attr("data-id");
            var payment_status = $(this).attr("data-pay-status");

            if(payment_status == 'paid'){
                Swal.fire({
                            position: "top-end",
                            type: "success",
                            title: "Payment already paid",
                            showConfirmButton: !1,
                            timer: 1500,
                            confirmButtonClass: "btn btn-success",
                            buttonsStyling: !1
                            })
                return
            }

            console.log($(this).parents('tr').children())
            items = $(this).parents('tr').children()
            var global_invoice_status_option = ''
            for (var i = 0; i < items.length; i++) {
                // console.log(item.getAttribute("class"))
                console.log(items[i].getAttribute("id"))
                if (items[i].getAttribute("id") == "invoice_status") {
                    global_invoice_status_option = items[i]
                    break;
                }
                // console.log(items[i])
            }

            console.log(global_invoice_status_option)

            var host_url = window.location.origin + '/invoice/payment/done/' + dataId
            Swal.fire({
                title: "Are you sure has payment been done?",
                text: "You won't be able to change this!",
                type: "warning",
                showCancelButton: !0,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes,Paid Payment ",
                confirmButtonClass: "btn btn-primary",
                cancelButtonClass: "btn btn-danger ml-1",
                buttonsStyling: !1,
                preConfirm: function (t) {
                    return fetch(host_url).then(function (t) {
                        if (!t.ok) throw console.log(t), new Error(t.statusText);
                        return t.json()
                    }).then(data=>{
                        if (data['error']) {
                            Swal.fire({
                                title: `${data['msg']}`,
                                confirmButtonClass: "btn btn-primary",
                                buttonsStyling: !1
                            })
                        }

                        if(data['status'] != 401){
                            global_invoice_status_option.innerHTML =
                        '<span class="badge badge-pill bg-success-light">Paid</span> '
                        }

                        // console.log(data)
                    }).catch(function (t) {
                        Swal.showValidationMessage("Request failed:  " + t)
                    })
                },
            }).then(function (response) {
                console.log("jubel")

                if(response['dismiss'] == 'cancel'){

                }else{
                    global_invoice_status_option.innerHTML =
                        '<span class="badge badge-pill bg-success-light">Paid</span> '
                     Swal.fire({
                            position: "top-start",
                            type: "success",
                            title: "Payment success done",
                            showConfirmButton: !1,
                            timer: 1500,
                            confirmButtonClass: "btn btn-primary",
                            buttonsStyling: !1
                         })
                    
                }

                // {isConfirmed: false, isDenied: false, isDismissed: true, dismiss: 'cancel'}

                console.log("ahmed")

                

                console.log("sdsads")
                console.log(response)

                

            })

        })
    })
</script>

{% endblock %}